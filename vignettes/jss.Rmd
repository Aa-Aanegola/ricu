---
title:
  formatted: "\\pkg{ricu}: \\proglang{R}'s interface for ICU data"
  plain:     "ricu: R's interface for ICU data"
  short:     "\\pkg{ricu}: R meets ICU data"
author:
  - name: Nicolas Bennett
    affiliation: ETH Z체rich
    address: >
      Seminar for Statistics
      R채mistrasse 101
      CH-8092 Zurich
    email: \email{nicolas.bennett@stat.math.ethz.ch}
  - name: Drago Plecko
    affiliation: ETH Z체rich
    address: >
      Seminar for Statistics
      R채mistrasse 101
      CH-8092 Zurich
    email: \email{drago.plecko@stat.math.ethz.ch}
  - name: Ida-Fong Ukor
    affiliation: East Kent Hospitals
    address: >
      NHS University Foundation Trust
      William Harvey Hospital
      Kennington Road, Willesborough
      Ashford TN24 0LZ
    email: \email{idafong.ukor@nhs.net}
abstract: >
  The abstract of the article.
keywords:
  formatted: [medicine, intensive care, computational bioinformatics]
  plain:     [medicine, intensive care, computational bioinformatics]
preamble: >
  \usepackage{amsmath}
vignette: >
  %\VignetteIndexEntry{Accessing ICU data with R (Bennett & Plecko, JSS 2020)}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
output: >
  if (packageVersion("rticles") < 0.5 || rmarkdown::pandoc_version() >= 2)
    rticles::jss_article else rmarkdown::html_vignette
documentclass: jss
bibliography: jss.bib
pkgdown:
  as_is: true
  extension: pdf
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE)

library(ricu)
library(data.table)
library(forestmodel)
library(survival)
library(ggplot2)

last_event <- function(x) c(rep(0, length(x)-1), max(x))

bin_labels <- function(breaks, unit, lower0 = TRUE) {

  x_labels <- sapply(1:(length(breaks)-1),
    function(x) paste0("[", breaks[x], "-", breaks[x+1], "]")
  )

  first_label <- paste0("< ", breaks[1])
  if (lower0) first_label <- paste0("[0-", breaks[1], "]")
  x_labels <- c(first_label, x_labels, paste0("> ", breaks[length(breaks)]))

  paste(x_labels, unit)
}

```

# Introduction

Collection of electronic health records has seen a significant rise in the recent years \cite{evans2016electronic}, opening up opportunities and providing the grounds for a large body of data-driven research oriented towards improving patient care and health outcomes, together with helping clinicians in decision-making \cite{jiang2017artificial}.

One example of a problem that has received much attention from the machine learning community is early prediction of sepsis in ICU \cite{desautels2016prediction, nemati2018interpretable, futoma2017improved, kam2017learning}. Interestingly, there is evidence that a large proportion of the publications are based on the same dataset \cite{fleuren2019machine}, the Medical Information Mart for Intensive Care (MIMIC) \cite{johnson2016mimic}, which shows a systematic lack of external validation. Part of this problem might well be the lack of a computational infrastructure handling multiple datasets. The MIMIC-III dataset consists of 26 different tables containing about 20GB of data. While much work and care has gone into data preprocessing in order to provide a self-contained ready to use data resource with MIMIC, seemingly simple tasks such as computing a SOFA score for patients \citep{vincent1996sofa}, remains a non trivial effort<!-- maybe add some citations and a sentence on label heterogeneity -->. This is only exacerbated when aiming to co-integrate multiple different datasets of this form is, spanning hospitals and even countries in order to capture effects of differing practice and demographics.

The aim of the \pkg{ricu} package is to provide computational infrastructure allowing users to access complex research questions as easily as possible. The package also aims to enable users to write dataset-agnostic code which can simplify implementation and shorten the necessary time for prototyping code to different datasets. In particular, the package handles three large, publicly available intensive care databases: the already mentioned MIMIC-III database from the Beth Israel Deaconess Medical Center in Boston, Massachusetts, the eICU Collaborative Research Database \cite{pollard2018eicu}, containing data collected from 208 hospitals across the United States, and the HiRID database \cite{faltys2020hirid} from the Department of Intensive Care Medicine of the Bern University Hospital, Switzerland. Together with this, much of the functionality used is also aimed to accommodate for addition of possible additional datasets, provided by the user. The work most similar to ours is that of \cite{adibuzzaman2016closing} and \cite{wang2020mimic}. However, these works address only the MIMIC-III dataset and do not have an emphasis on dataset inter-operability.

<!-- paragraph on observed differences between datasets: absolute vs relative times, difftime intervals, id systems, etc. -->

The structure of the manuscript is as follows. In Section \ref{implementation} we outline the different types of data useful for research related to intensive care medicine. We explain the most important parts of the package functionality which are used to handle the different data types. In Section \ref{examples} we provide simple examples which illustrate how some simple research questions can be explored in only a couple of lines of code.

# Implementation

In this Section we go over the categories of data useful for research problems related to intensive care medicine. The categories we define are fairly broad and somewhat loosely defined, as this is not the main focus of the manuscript.

## Physiological data
Labs, vitals. Could introduce the \code{ts_tbl} here.

## Treatment-related information
Antibiotics, vasopressors, mechanical ventilation... could introduce the \code{win_tbl} here.

## Co-morbidities

Based on ICD-9 codes. Should enable the extraction of co-morbidities used for the Charlson and Elixhauser scores.

## Admission diagnoses
Categorizing into surgical, non-surgical and other might be sufficient for now.

## Patient information
Age, gender, other demograpichs, patient stay information.

## Outcomes
Death outcome, prolonged ICU stay outcome.

# Examples

We focus on two simple examples with which we try to cover most of the data types described in Section \ref{implementation}.

```{r tcm_loader, include = FALSE}
load_concepts <- cached_concept_loader("tcm")
```

## Lactate and mortality
The first example we look at is the association of lactate levels and mortality. This problem has been studied before and it is widely accepted that both static and dynamic lactate indices are associated with increased mortality \citep{haas2016severe, nichol2011dynamic, van2013cumulative}. We quickly look at how one might fit a time-varying proportional hazards Cox model \citep{therneau2015package} in order to investigate this problem. We additionally include the Sequential Organ Failure Assessment (SOFA) score \citep{vincent1996sofa} as a general predictor of illness severity.

```{r time_cox_model}
# data loading
tbl <- load_concepts(c("lact", "death", "sofa"), "mimic_demo",
                     verbose = FALSE)
tbl <- tbl[, c(meta_vars(tbl), "lact", "sofa", "death"), with = FALSE]
tbl <- tbl[, lact := nafill(lact, "locf")]
tbl <- tbl[, lact := nafill(lact, fill = 1)]
tbl[, event := as.integer(sum(death, na.rm = TRUE) > 0), by = c(id_vars(tbl))]
tbl[, event := last_event(event), by = c(id_vars(tbl))]
tbl[, next_charttime := charttime+1L]
# model fitting
cox_time_mod <- coxph(
  Surv(charttime, next_charttime, event) ~ lact + sofa,
  data = tbl
)
```

We visualize the results of the model

```{r cox_plot, echo = FALSE, warning = FALSE, message = FALSE}
forest_model(cox_time_mod)
```

A simple exploration already shows that the increased values of lactate are associated with mortality, even after adjusting for the SOFA score.

```{r diab_loader, include = FALSE}
load_concepts <- cached_concept_loader("diab")
```

## Diabetes and insulin treatment
The next example we turn to covers the usage of co-morbidities and treatment related information. We look at the amount of insulin administered to patients in the first 24 hours from their ICU admission. In particular, we investigate if patients who are diabetic receive more insulin in the first day of their stay. We extract the data as follows:

```{r diabetes}
ins_breaks <- c(0.01, 10, 20, 30, 40)

ins_cb <- function(ins, ...) {

  idx_var <- index_var(ins)
  ids_var <- id_vars(ins)

  ins <- ins[get(idx_var) <= hours(24L), list(ins24 = sum(ins)),
             by = c(ids_var)]
  ins <- ins[, ins24 := list(
             .bincode(ins24, breaks = c(-Inf, ins_breaks, Inf)) - 1)]

  ins
}

grep_diab <- function(x) grepl("^250\\.?[0-9]{2}$", x)

ins24 <- load_dictionary("mimic_demo", "ins")
ins24 <- concept("ins24", ins24, "insulin in first 24h", aggregate = "sum",
                 callback = ins_cb, target = "id_tbl", class = "rec_cncpt")
diab  <- item("mimic_demo", table = "diagnoses_icd",
              callback = transform_fun(grep_diab), class = "col_itm")
diab  <- concept("diab", diab, "diabetes", target = "id_tbl",
                 class = "lgl_cncpt")

dat <- load_concepts(c(ins24, diab), id_type = "icustay", verbose = FALSE)
dat <- replace_na(dat, 0, cols = "ins24")
```

After this, we can visualize the difference between the two groups with a histogram:

```{r diabetes_visualize, echo = FALSE}
ggplot(dat, aes(x = ins24, fill = diab, colour = diab)) +
  geom_histogram(aes(y = ..count.. / sum(..count..)), alpha = 0.75,
                 position = "dodge", bins = 1 + length(ins_breaks)) +
  xlab("Amount of administered insulin in first 24h of ICU stay") +
  ylab("Proportion of patients") +
  scale_x_continuous(labels = bin_labels(ins_breaks, "units"),
                     breaks = c(0, seq_along(ins_breaks))) +
  theme_minimal(10) +
  theme(legend.position = c(0.7, 0.7),
        legend.background = element_blank(),
        legend.box.background = element_rect(colour = "black"),
        legend.text = element_text(size = 12),
        legend.title = element_text(size = 16))
```

The plot might suggest that diabetic patients do receive more insulin that non-diabetic patients, in the first day of ICU stay.
